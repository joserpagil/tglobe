<!doctype html>
<html lang='en'>

<head>

	<meta charset='utf-8' />

	<script src='./js/react.development.js'></script>
	<script src='./js/react-dom.development.js'></script>
	<script src='./js/babel.min.js'></script>

	<script src='./js/three.min.js'></script>
	<script src='./js/OrbitControls.js'></script>

	<title>
		world v221119 x joserpagil@gmail.
	</title>

</head>

<style>

	body {
		margin : 0 ;
	}
	
	#log_div {
		background : red   ;
		color      : white ;
	}
	
	#Ap {
		width  : 100% ;
		height : 100% ;
	}

</style>

<body>

	<div id = 'Ap' /></div >
	<div id = 'log_div'></div >

	<script type='text/babel'>
	
		const Log  = args =>  {
			log_div . innerHTML += args . html + '<br>'
		}
		addEventListener ( 'error' , errorEvent => { Log ( { html : errorEvent . lineno + ' , ' + errorEvent . colno + ' - ' + errorEvent . message } ) } )
	
		const Globe = props => {
			const [ states, set_states ]    = React . useState ( [  ] )
			const container_ref             = React . useRef   ( null )	
			
			const width  = props . width
			const height = props . height
			
			const radius                      = 500
			const cloud_height                = radius * 1.05 //   5000
			const billboard_height            = radius * 1.06 //   5000
			const Marker_size                 =  10
			const Deg2Rad                     = Math.PI / 180
			const Rad2Deg                     = 180 / Math.PI
			let   scene                       = null
			let   renderer                    = null
			
			const Lat_lon_to_cartesian         = args => {
				const phi   = ( 90 - args . lat ) * Deg2Rad
				const theta = (    - args . lon ) * Deg2Rad
				return {
					x : radius * Math . sin ( phi ) * Math . cos ( theta ) ,
					y : radius * Math . cos ( phi ) ,
					z : radius * Math . sin ( phi ) * Math . sin ( theta )
				}
			}
			class Lat_lon                {
				constructor ( args ) {
					this . lat = 0
					this . lon = 0
					
					if ( args ) {
						if ( 'lat' in args ) this . lat = args . lat
						if ( 'lon' in args ) this . lon = args . lon
					}
				}
			}
			class Marker extends Lat_lon {
				constructor ( args ) {
					super ( args )
					
					this . mesh = new THREE . Mesh ( 
						new THREE . PlaneGeometry ( Marker_size , Marker_size ) , 
						new THREE . MeshBasicMaterial ( {
							color : 'hotpink' ,
							side  : THREE.DoubleSide ,
						} )
					)
					const cartesian = Lat_lon_to_cartesian ( { lat : this . lat , lon : this .lon } )
					this . mesh . lookAt         ( cartesian . x        , cartesian . y      , cartesian . z ) 
					this . mesh . position . set ( cartesian . x        , cartesian . y      , cartesian . z )
				}
			}
			
			const create_scene              = args => {
				
				const Init_ThreeJS   = args => {
					const Render                      = args => {
						renderer . render ( scene , camera )
					}
					const Tik                         = args => {
						cloud_mesh . rotation . y += .001
						
						Render ()
					}

					scene                               = new THREE . Scene             ()
					const camera                              = new THREE . PerspectiveCamera ( 50 , width / height , .1 , radius * 8 )
					camera           . position . z           = radius * 4
					renderer                                  = new THREE . WebGLRenderer     ()
					//renderer         . setPixelRatio                                          ( devicePixelRatio )
					renderer         . setSize                                                ( width , height )
					container_ref    . current  . appendChild                                 ( renderer . domElement )
					
					scene            . add                                                    ( new THREE . AmbientLight ( - 1 , .2 ) )
					const pointLight                          = new THREE . PointLight        ( 0xffffff , 0.9 )
					pointLight       . position . set                                         ( radius * 4 * 5 , radius * 4 * 5 , radius * 4 * 5 )
					scene            . add                                                    ( pointLight )

					const earth_mesh = new THREE . Mesh (
						new THREE . SphereGeometry    ( radius , 32 , 32 ) ,
						new THREE . MeshStandardMaterial ( {
							map       : new THREE . TextureLoader () . load ( './assets/earthmap1k.jpg' ) ,
							bumpMap   : new THREE . TextureLoader () . load ( './assets/earthbump.jpg' ) ,
							bumpScale : radius / 4 } ) )
					scene . add ( earth_mesh )

					const cloud_mesh = new THREE . Mesh (
						new THREE . SphereGeometry    ( cloud_height , 32 , 32 ) ,
						new THREE . MeshStandardMaterial ( {
							map         : new THREE . TextureLoader () . load ( './assets/earthCloud.png' ) ,
							transparent : true } ) )
					scene . add ( cloud_mesh )
					
					const orbitControls = new THREE . OrbitControls ( camera , renderer . domElement )
					
					setInterval ( Tik , 1000 / 33 )			
				}
				const Create_markers = args => {
					for ( const poi of props . pois ) {
						const marker = new Marker ( poi )
						scene . add ( marker . mesh )
					}
				}
				Init_ThreeJS ()
				Create_markers ()
			}
			const destroy_scene             = args => {
				//cancelAnimationFrame ( frameId )
				//container_ref . current . removeChild ( renderer . domElement )
			}
			React . useEffect ( () => {
				if ( ! renderer ) {
					create_scene ()
				}
				
				return destroy_scene
			}, [] )	
			
			return <div ref = { container_ref } />
		}

		class Ap extends React . Component {
			constructor ( props ) {
				super( props )
				
				this . pois = [
					{ description : 'me'          , lat : 10.204577 , lon : -  68.180777 } , 
					{ description : 'you'         , lat : 55.676098 , lon :    12.568337 } , 
					{ description : 'la'          , lat : 34.0522   , lon : - 118.2437   } , 					
					{ description : 'nyc'         , lat : 40.730610 , lon : -  73.935242 } , 					
					{ description : 'eiffel'      , lat : 48.857778 , lon :     2.294876 } , 
					{ description : 'giza'        , lat : 29.980387 , lon :    31.134191 } , 
					{ description : 'teotihuacan' , lat : 19.686081 , lon : -  98.871635 } , 	
				]
			}
			render      () {
				return (
					<Globe
						width  = { window . innerWidth   }
						height = { window . innerHeight  }
						pois   = { this   . pois         }
					/>
				)
			}
		}

		ReactDOM . render ( <Ap /> , document . getElementById ( 'Ap' ) )

	</script>

</body>

</html>
